{% extends "base.html" %}

{% block title %}Advanced Stats - Trading Journal{% endblock %}

{% block content %}
<!-- Profile Switcher -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-primary mb-0">
                    <i class="fas fa-chart-bar me-2"></i>{{ viewed_user.display_name }}'s Advanced Statistics
                </h2>
                <p class="text-muted mb-0">Deep dive into trading performance metrics</p>
            </div>
            <div class="profile-switcher">
                <div class="btn-group" role="group">
                    {% for user in all_users %}
                    <a href="{{ url_for('advanced_stats', user=user.id) }}" 
                       class="btn {{ 'btn-primary' if user.id == current_view_user_id else 'btn-outline-primary' }} btn-sm">
                        {{ user.display_name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if not trades %}
<div class="row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-body py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">{{ viewed_user.display_name }} has no trading data available</h4>
                <p class="text-muted">{{ 'Add some trades to see advanced statistics' if viewed_user.id == session.user_id else 'This trader hasn\'t started logging trades yet' }}</p>
                {% if viewed_user.id == session.user_id %}
                <a href="{{ url_for('add_trade') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Your First Trade
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Exit Reason Analysis -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-door-open me-2 text-primary"></i>Exit Reason Analysis
                </h4>
                <small class="text-muted">Performance breakdown by how you closed trades</small>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    {% for reason, stats in exit_stats.items() %}
                    <div class="col-lg-6 col-xl-4">
                        <div class="exit-reason-card p-4 rounded-3" style="background: var(--glass-bg); border: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="mb-0">{{ reason }}</h5>
                                <span class="badge bg-secondary">{{ stats.count }} trades</span>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="stat-item">
                                        <div class="stat-label">Avg Return</div>
                                        <div class="stat-value {{ 'positive' if stats.avg_return > 0 else 'negative' if stats.avg_return < 0 else 'neutral' }}">
                                            {{ "+" if stats.avg_return > 0 else "" }}{{ stats.avg_return }}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item">
                                        <div class="stat-label">Win Rate</div>
                                        <div class="stat-value">{{ stats.win_rate }}%</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item">
                                        <div class="stat-label">Frequency</div>
                                        <div class="stat-value">{{ stats.frequency }}%</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item">
                                        <div class="stat-label">Total P&L</div>
                                        <div class="stat-value {{ 'positive' if stats.total_pnl > 0 else 'negative' if stats.total_pnl < 0 else 'neutral' }}">
                                            {{ "+" if stats.total_pnl > 0 else "" }}{{ stats.total_pnl }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-top" style="border-color: var(--border-color) !important;">
                                <small class="text-muted">
                                    {{ stats.wins }}W / {{ stats.breakevens }}BE / {{ stats.losses }}L
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Trends -->
<div class="row">
    <div class="col-lg-8">
        <!-- Monthly Performance -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-alt me-2 text-primary"></i>Monthly Performance
                </h4>
                <small class="text-muted">Track your progress over time</small>
            </div>
            <div class="card-body">
                {% if performance_trends.monthly %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Total P&L</th>
                                <th>Avg/Trade</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month_key, data in performance_trends.monthly.items() %}
                            <tr>
                                <td class="fw-medium">{{ data.month_name }}</td>
                                <td>{{ data.total_trades }}</td>
                                <td>{{ data.win_rate }}%</td>
                                <td class="{{ 'positive' if data.total_pnl > 0 else 'negative' if data.total_pnl < 0 else 'neutral' }}">
                                    {{ "+" if data.total_pnl > 0 else "" }}{{ data.total_pnl }}%
                                </td>
                                <td class="{{ 'positive' if data.avg_trade > 0 else 'negative' if data.avg_trade < 0 else 'neutral' }}">
                                    {{ "+" if data.avg_trade > 0 else "" }}{{ data.avg_trade }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No monthly data available yet</p>
                {% endif %}
            </div>
        </div>

        <!-- Day of Week Performance -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-week me-2 text-primary"></i>Day of Week Performance
                </h4>
                <small class="text-muted">Find your best trading days</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
                    {% set day_data = performance_trends.daily[day] %}
                    <div class="col-lg-4 col-md-6">
                        <div class="day-performance-card p-3 rounded-3" style="background: var(--glass-bg); border: 1px solid var(--border-color);">
                            <h6 class="mb-2">{{ day }}</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="small text-muted">Trades</div>
                                    <div class="fw-medium">{{ day_data.total_trades }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">Win Rate</div>
                                    <div class="fw-medium">{{ day_data.win_rate }}%</div>
                                </div>
                                <div class="col-12">
                                    <div class="small text-muted">Avg P&L</div>
                                    <div class="fw-medium {{ 'positive' if day_data.avg_trade > 0 else 'negative' if day_data.avg_trade < 0 else 'neutral' }}">
                                        {{ "+" if day_data.avg_trade > 0 else "" }}{{ day_data.avg_trade }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Streak Analysis -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-fire me-2 text-primary"></i>Streak Analysis
                </h4>
                <small class="text-muted">Track your hot and cold streaks</small>
            </div>
            <div class="card-body">
                <div class="streak-stats">
                    <div class="streak-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="streak-label">Current Streak</span>
                            <span class="streak-value fs-4 fw-bold {{ 'positive' if performance_trends.streaks.current > 0 else 'negative' if performance_trends.streaks.current < 0 else 'neutral' }}">
                                {% if performance_trends.streaks.current > 0 %}
                                    +{{ performance_trends.streaks.current }}
                                {% elif performance_trends.streaks.current < 0 %}
                                    {{ performance_trends.streaks.current }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </div>
                        <small class="text-muted">
                            {% if performance_trends.streaks.current > 0 %}
                                {{ performance_trends.streaks.current }} winning trades in a row
                            {% elif performance_trends.streaks.current < 0 %}
                                {{ performance_trends.streaks.current|abs }} losing trades in a row
                            {% else %}
                                No active streak
                            {% endif %}
                        </small>
                    </div>

                    <div class="streak-item mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="streak-label">Best Winning Streak</span>
                            <span class="streak-value fs-5 fw-bold text-success">{{ performance_trends.streaks.longest_win }}</span>
                        </div>
                        <small class="text-muted">Longest series of wins</small>
                    </div>

                    <div class="streak-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="streak-label">Worst Losing Streak</span>
                            <span class="streak-value fs-5 fw-bold text-danger">{{ performance_trends.streaks.longest_loss }}</span>
                        </div>
                        <small class="text-muted">Longest series of losses</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<style>
.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-weight: 600;
    font-size: 1.1rem;
}

.exit-reason-card {
    transition: all 0.3s ease;
}

.exit-reason-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 212, 170, 0.1);
}

.day-performance-card {
    transition: all 0.3s ease;
}

.day-performance-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 212, 170, 0.1);
}

.streak-item {
    padding: 1rem;
    background: var(--glass-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.streak-label {
    color: var(--text-secondary);
    font-weight: 500;
}
</style>
{% endblock %}